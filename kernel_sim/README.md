# aocl-kernel-sim

Simple "framework" for Altera OpenCL Kernel RTL simulation.

## Synopsys
When I was studing Altera OpenCL I need understand how data flows in kernel.
On hardware (with SignalTap) it's time-consuming.

I just added:
  - some debug display's in acl files.
  - simulation of global memory (with loading data for kernel)

Simulation log looks like this:
```
# 30992500: 4427[   1]: lsu_local_bb1_ld_: IN_R_256: addr = 0x00000280
# 30999500: 4428[  FT]: lsu_local_bb1_ld_: AVM_READ_REQ_256: addr = 0x00000000 burst = 0x10 byteen = 0xffffffff
# 30999500: 4428[   1]: lsu_local_bb1_ld_: IN_R_256: addr = 0x000002a0
# 31006500: 4429[   1]: lsu_local_bb1_ld_: IN_R_256: addr = 0x000002c0
# 31104500: 4443[   1]: lsu_local_bb1_ld_: OUT_R_256: data = 0x00000053000000470000003b0000002f00000023000000170000000bffffffff
# 31104500: 4443[   1]: lsu_local_bb1_st_c1_exe1: IN_W_256: addr = 0x00400020 data = 0x0000001b00000017000000130000000f6363162b631663c51663637b63636316
# 31111500: 4444[  16]: lsu_local_bb1_ld_: AVM_READ_REQ_256: addr = 0x00000200 burst = 0x10 byteen = 0xffffffff
# 31111500: 4444[   1]: lsu_local_bb1_ld_: AVM_READ_256: data = 0x0000008b00000077000000630000004f0000003b0000002700000013ffffffff
# 31111500: 4444[   1]: lsu_local_bb1_ld_: OUT_R_256: data = 0x00000061000000530000004500000037000000290000001b0000000dffffffff
# 31111500: 4444[   1]: lsu_local_bb1_st_c1_exe1: IN_W_256: addr = 0x00400040 data = 0x00000029000000230000001d00000017636316826316632b1663636b63636316
```

## how it works
Kernel needs two Avalon-MM interfaces:
  - `cra` - control/status registers [kernel is slave]
  - `memgmem` - interface to global memory [kernel is master]

We need both interfaces to emulate.

For global memory we can use models, for example On-Chip Memory.
It got different latency/throughput than DDR3/QDR external memory, 
but in most cases for understanding where bottlneck in kernel is, 
we can ignore this. 

If you need more real simulation, you can add in ram_model DDR/QDR model from Altera (may be I do it someday).

## Usage
For example you got OpenCL kernel 

```opencl
__kernel void k( ... ) {
  ...
}
```
in file `k.cl`.

Generate `aoco` file:
```
aoc k.cl -c --board $BOARD_NAME -v -g
```
where `$BOARD_NAME` is name of board you using. I used de1soc_sharedonly.

You'll get directory `k` with autogenerated RTL files for your kernel system `k_system.v` and `k.v`.

This files must be copied to directory with `kernel_sim`.

Change in `top_tb.sv`:
  - insert `k_system` instance
  - create input data (for kernel)
  - setup kernel (via `cra` interface)

Change in `make.do` path to quartus `sim_lib`.

Start simulation (in ModelSim):
```
vsim -do make.do
```

See log (`transcript`) and/or waveforms.

## example
I add `vector\_add` example that generates from this kernel:

```opencl
__kernel void vector_add( __global const uint *restrict x, 
    __global const uint *restrict y, 
    __global       uint *restrict z )
{
  // get index of the work item
  int index = get_global_id(0);

  // add the vector elements
  z[index] = x[index] + y[index];
}
```

## 00index
- altera\_src - Altera RTL Sources (from Quartus 15.1)
- ram\_models - models for Global Memory
   - onchip\_ram\_256b - 8 MB onchip buffer, amm\_width = 256, amm\_maxburst = 16

